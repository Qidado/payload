{"version":3,"sources":["../../../src/collections/operations/findDistinct.ts"],"sourcesContent":["import httpStatus from 'http-status'\n\nimport type { AccessResult } from '../../config/types.js'\nimport type { PaginatedDistinctDocs } from '../../database/types.js'\nimport type { PayloadRequest, PopulateType, Sort, Where } from '../../types/index.js'\nimport type { Collection } from '../config/types.js'\n\nimport { executeAccess } from '../../auth/executeAccess.js'\nimport { combineQueries } from '../../database/combineQueries.js'\nimport { validateQueryPaths } from '../../database/queryValidation/validateQueryPaths.js'\nimport { sanitizeWhereQuery } from '../../database/sanitizeWhereQuery.js'\nimport { APIError } from '../../errors/APIError.js'\nimport { Forbidden } from '../../errors/Forbidden.js'\nimport { relationshipPopulationPromise } from '../../fields/hooks/afterRead/relationshipPopulationPromise.js'\nimport { appendNonTrashedFilter } from '../../utilities/appendNonTrashedFilter.js'\nimport { getFieldByPath } from '../../utilities/getFieldByPath.js'\nimport { killTransaction } from '../../utilities/killTransaction.js'\nimport { buildAfterOperation } from './utils.js'\n\nexport type Arguments = {\n  collection: Collection\n  depth?: number\n  disableErrors?: boolean\n  field: string\n  limit?: number\n  locale?: string\n  overrideAccess?: boolean\n  page?: number\n  populate?: PopulateType\n  req?: PayloadRequest\n  showHiddenFields?: boolean\n  sort?: Sort\n  trash?: boolean\n  where?: Where\n}\nexport const findDistinctOperation = async (\n  incomingArgs: Arguments,\n): Promise<PaginatedDistinctDocs<Record<string, unknown>>> => {\n  let args = incomingArgs\n\n  try {\n    // /////////////////////////////////////\n    // beforeOperation - Collection\n    // /////////////////////////////////////\n\n    if (args.collection.config.hooks?.beforeOperation?.length) {\n      for (const hook of args.collection.config.hooks.beforeOperation) {\n        args =\n          (await hook({\n            args,\n            collection: args.collection.config,\n            context: args.req!.context,\n            operation: 'readDistinct',\n            req: args.req!,\n          })) || args\n      }\n    }\n\n    const {\n      collection: { config: collectionConfig },\n      disableErrors,\n      overrideAccess,\n      populate,\n      showHiddenFields = false,\n      trash = false,\n      where,\n    } = args\n\n    const req = args.req!\n    const { locale, payload } = req\n\n    // /////////////////////////////////////\n    // Access\n    // /////////////////////////////////////\n\n    let accessResult: AccessResult\n\n    if (!overrideAccess) {\n      accessResult = await executeAccess({ disableErrors, req }, collectionConfig.access.read)\n\n      // If errors are disabled, and access returns false, return empty results\n      if (accessResult === false) {\n        return {\n          hasNextPage: false,\n          hasPrevPage: false,\n          limit: args.limit || 0,\n          nextPage: null,\n          page: 1,\n          pagingCounter: 1,\n          prevPage: null,\n          totalDocs: 0,\n          totalPages: 0,\n          values: [],\n        }\n      }\n    }\n\n    // /////////////////////////////////////\n    // Find Distinct\n    // /////////////////////////////////////\n\n    let fullWhere = combineQueries(where!, accessResult!)\n    sanitizeWhereQuery({ fields: collectionConfig.flattenedFields, payload, where: fullWhere })\n\n    // Exclude trashed documents when trash: false\n    fullWhere = appendNonTrashedFilter({\n      enableTrash: collectionConfig.trash,\n      trash,\n      where: fullWhere,\n    })\n\n    await validateQueryPaths({\n      collectionConfig,\n      overrideAccess: overrideAccess!,\n      req,\n      where: where ?? {},\n    })\n\n    const fieldResult = getFieldByPath({\n      fields: collectionConfig.flattenedFields,\n      path: args.field,\n    })\n\n    if (!fieldResult) {\n      throw new APIError(\n        `Field ${args.field} was not found in the collection ${collectionConfig.slug}`,\n        httpStatus.BAD_REQUEST,\n      )\n    }\n\n    if (fieldResult.field.hidden && !showHiddenFields) {\n      throw new Forbidden(req.t)\n    }\n\n    if (fieldResult.field.access?.read) {\n      const hasAccess = await fieldResult.field.access.read({ req })\n      if (!hasAccess) {\n        throw new Forbidden(req.t)\n      }\n    }\n\n    let result = await payload.db.findDistinct({\n      collection: collectionConfig.slug,\n      field: args.field,\n      limit: args.limit,\n      locale: locale!,\n      page: args.page,\n      req,\n      sort: args.sort,\n      where: fullWhere,\n    })\n\n    if (\n      (fieldResult.field.type === 'relationship' || fieldResult.field.type === 'upload') &&\n      args.depth\n    ) {\n      const populationPromises: Promise<void>[] = []\n      for (const doc of result.values) {\n        populationPromises.push(\n          relationshipPopulationPromise({\n            currentDepth: 0,\n            depth: args.depth,\n            draft: false,\n            fallbackLocale: req.fallbackLocale || null,\n            field: fieldResult.field,\n            locale: req.locale || null,\n            overrideAccess: args.overrideAccess ?? true,\n            parentIsLocalized: false,\n            populate,\n            req,\n            showHiddenFields: false,\n            siblingDoc: doc,\n          }),\n        )\n      }\n      await Promise.all(populationPromises)\n    }\n\n    // /////////////////////////////////////\n    // afterOperation - Collection\n    // /////////////////////////////////////\n\n    result = await buildAfterOperation({\n      args,\n      collection: collectionConfig,\n      operation: 'findDistinct',\n      result,\n    })\n\n    // /////////////////////////////////////\n    // Return results\n    // /////////////////////////////////////\n\n    return result\n  } catch (error: unknown) {\n    await killTransaction(args.req!)\n    throw error\n  }\n}\n"],"names":["httpStatus","executeAccess","combineQueries","validateQueryPaths","sanitizeWhereQuery","APIError","Forbidden","relationshipPopulationPromise","appendNonTrashedFilter","getFieldByPath","killTransaction","buildAfterOperation","findDistinctOperation","incomingArgs","args","collection","config","hooks","beforeOperation","length","hook","context","req","operation","collectionConfig","disableErrors","overrideAccess","populate","showHiddenFields","trash","where","locale","payload","accessResult","access","read","hasNextPage","hasPrevPage","limit","nextPage","page","pagingCounter","prevPage","totalDocs","totalPages","values","fullWhere","fields","flattenedFields","enableTrash","fieldResult","path","field","slug","BAD_REQUEST","hidden","t","hasAccess","result","db","findDistinct","sort","type","depth","populationPromises","doc","push","currentDepth","draft","fallbackLocale","parentIsLocalized","siblingDoc","Promise","all","error"],"mappings":"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"}